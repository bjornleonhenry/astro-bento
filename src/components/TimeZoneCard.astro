---
import {
  getCurrentTimeInLosAngeles,
  formatTimeForLosAngeles,
} from "../lib/helpers";
import Card from "./Card/index.astro";
---

<script>
  import { onCleanup, onMount } from "solid-js";
  import { formatTimeForLosAngeles } from "../lib/helpers";
  let interval: ReturnType<typeof setInterval> | undefined;
  let lastText = "";

  function updateClock() {
    if (typeof document === "undefined") return;
    if (document.hidden) return; // don't update while page is hidden

    const el = document.getElementById("timeDisplay");
    if (!el) return;

    const now = new Date();
    const nextText = formatTimeForLosAngeles(now);

    // Only mutate the DOM if the displayed text actually changes
    if (nextText !== lastText) {
      el.textContent = nextText;
      el.setAttribute("datetime", now.toISOString());
      lastText = nextText;
    }
  }

  function startClock() {
    if (!interval) {
      updateClock();
      interval = setInterval(updateClock, 1000);
    }
  }

  function stopClock() {
    if (interval) {
      clearInterval(interval);
      interval = undefined;
    }
  }

  function handleVisibilityChange() {
    if (typeof document === "undefined") return;
    if (document.hidden) stopClock();
    else startClock();
  }

  onMount(() => {
    if (typeof document !== "undefined") {
      document.addEventListener("visibilitychange", handleVisibilityChange);
      handleVisibilityChange();
    }
  });

  onCleanup(() => {
    stopClock();
    if (typeof document !== "undefined") {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
    }
  });
</script>

<Card colSpan="lg:col-span-2" rowSpan="md:row-span-2" title="Local Time:">
  <!-- <div class="text-xl md:text-lg lg:text-2xl text-neutral-100/70">
    Boulder, CO, CA.
  </div> -->

  <time
    datetime=""
    id="timeDisplay"
    class="text-3xl md:text-2xl lg:text-5xl flex f-bold h-full mt-5"
  >
    {formatTimeForLosAngeles(getCurrentTimeInLosAngeles())}
  </time>
</Card>
