---
import { formatDate, formatTag } from "../lib/helpers";
import type { MarkdownLayoutProps } from "astro";
import BasicLayout from "./BasicLayout.astro";
import { Icon } from "astro-icon/components";
import Navbar from "../components/Navbar.astro";

// Use a permissive props type to avoid strict layout frontmatter constraints from Astro's types
type Props = Record<string, any>;

const { slug } = Astro.params;
const { frontmatter } = Astro.props;

// Try to get data from remarkPluginFrontmatter if frontmatter is missing custom fields
// `Astro.locals` doesn't include custom plugin-provided fields in its TS type,
// assert to `any` to avoid a compile error while remaining safe at runtime.
const actualFrontmatter = frontmatter || (Astro.locals as any)?.remarkPluginFrontmatter || {};
// Provide safe defaults for template usage
const fmTitle = actualFrontmatter.title ?? "";
const fmDescription = actualFrontmatter.description ?? "";
const fmTags = Array.isArray(actualFrontmatter.tags) ? actualFrontmatter.tags : [];
const fmImage = actualFrontmatter.image ?? "";
const fmCategory = actualFrontmatter.category ?? "";
const fmPubDate = actualFrontmatter.pubDate ?? "";
const fmMinutesRead = actualFrontmatter.minutesRead ?? "";
const fmProjectURL = actualFrontmatter.projectURL ?? "";
---

<BasicLayout
  frontmatter={actualFrontmatter}
  slug={slug}
  page="blog"
  title={`Bjorn Leon Henry - ${fmTitle}`}
  description={fmDescription}
>
  <Navbar />

  <main class="mx-auto max-w-2xl w-full p-2 md:py-5 text-neutral-100">
    <div
      class="w-fit px-4 py-1 rounded rounded-b-none border-b-none border border-gray-500"
    >
      <a
        href={`/${fmCategory}`}
        class="text-neutral-100 capitalize text-sm decoration-none"
      >
        {fmCategory}
      </a>
    </div>
    <div class="border-t border-gray-500">
      <div class="flex justify-between mt-2 text-neutral-100/50 text-sm">
        <p>{fmMinutesRead}</p>
        <p>{fmPubDate ? formatDate(new Date(fmPubDate)) : ""}</p>
      </div>

      <div class="text-5xl f-bold mt-2 opacity-0" id="post-title" aria-hidden="true">
        {fmTitle}
      </div>
      <div class="text-neutral-100/70 opacity-0" id="post-description" aria-hidden="true">
        {fmDescription}
      </div>

      <div class="">
        <div class="mt-5 pb-1 text-neutral-100/50 f-light text-sm">
          <a
            href="/tags"
            class="text-neutral-100/50 f-light decoration-none hover:decoration-none"
            >Tags:</a
          >
        </div>

        <div class="flex gap-1 w-full overflow-scroll mb-2">
          {
            fmTags.map((tag: string) => (
              <a
                href={`/tags/${formatTag(tag)}`}
                class="no-underline hover:no-underline text-sm bg-gray-700 text-neutral-100 rounded px-2 py-1 lowercase whitespace-nowrap"
              >
                #{formatTag(tag)}
              </a>
            ))
          }
        </div>
      </div>

      <a href={fmProjectURL || "hover:skew-y-12"}>
        <img
          src={fmImage}
          alt=""
          class="border border-gray-500/50 w-full object-cover h-full opacity-0"
          id="post-image"
          aria-hidden="true"
        />
      </a>
    </div>

    <div class="flex items-center gap-2 w-full py-2">
      {
        fmCategory === 'projects' && (
          <a href={`https://github.com/bjornleonhenry/${slug}`} class="w-full group" target="_blank">
            <button class="text-neutral-100 bg-gray-700 md:hover:text-neutral-100 transition-all duration-200 rounded py-2 px-4 flex-1 w-full">
              <div class="flex items-center justify-between gap-2">
                <div>go to app</div>
                <Icon
                  name="ri:login-circle-fill"
                  class="w-5 h-5 md:group-hover:scale-110 transition-all duration-100"
                />
              </div>
            </button>
          </a>
        )
      }
      {
        fmCategory === 'projects' && (
          <a href={`https://github.com/bjornleonhenry/${slug}`} class="w-full group" target="_blank"> 
            <button class="text-neutral-100 bg-gray-700 md:hover:text-neutral-100 transition-all duration-200 rounded py-2 px-4 flex-1 w-full">
              <div class="flex items-center justify-between gap-2">
                <div>star on github</div>
                <Icon
                  name="ri:github-fill"
                  class="w-5 h-5 md:group-hover:scale-110 transition-all duration-100"
                />
              </div>
            </button>
          </a>
        )
      }
    </div>

    <article
      class="prose prose-p:text-purple-500 prose-slate prose-invert mb-10 opacity-0"
      id="post-content"
      aria-hidden="true"
    >
      <slot />
    </article>
  </main>
</BasicLayout>

<style is:global>
  ::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  import { gsap } from "gsap";

  document.addEventListener("DOMContentLoaded", () => {
    gsap.to("#post-title", {
      opacity: 1,
      duration: 0.5,
      onComplete: () => {
        document.getElementById("post-title")?.removeAttribute("aria-hidden");
      }
    });
    gsap.to("#post-image", {
      opacity: 1,
      duration: 1,
      onComplete: () => {
        document.getElementById("post-image")?.removeAttribute("aria-hidden");
      }
    });
    gsap.to("#post-description", {
      opacity: 1,
      duration: 1.5,
      onComplete: () => {
        document.getElementById("post-description")?.removeAttribute("aria-hidden");
      }
    });
    gsap.to("#post-content", {
      opacity: 1,
      delay: 0.25,
      duration: 0.5,
      onComplete: () => {
        document.getElementById("post-content")?.removeAttribute("aria-hidden");
      }
    });
  });
</script>
